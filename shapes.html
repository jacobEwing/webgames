<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<style type="text/css">
		* { margin: 0; padding : 0 }
		body, html {
			height: 100%;
		}
	</style>
	<script type="text/javascript">
		var context, canvasWidth = 800, canvasHeight = 600, mouseX = -1, mouseY = -1, shape=[], numShapes = 0, colourAngle = 0, leadShape = null, mouseDown = false;


		var shapeClass = function(){
			this.colour = { 'R' : 255, 'G' : 255, 'B' : 255 };
			this.position = { x : 0, y : 0 };
			this.numpoints = this.radius = 0;
			this.points = [];
			this.velocity = { x : 0, y : 0 };
			this.opacity = 1;
			this.sine = this.cosine = 0;
			this.parentShape = null;
			this.childShape = null;
		};

		shapeClass.prototype.getTrigVals = function(ang){
			this.sine = Math.sin(ang);
			this.cosine = Math.cos(ang);
		};

		shapeClass.prototype.move = function(){
			var n;
			if(this.parentShape == null){
				this.velocity.y++;
				this.position.x += this.velocity.x;
				this.position.y += this.velocity.y;
			}else{
				e4 = this.parentShape.position.x;
				e7 = this.parentShape.position.y;
				e6 = this.position.x;
				e5 = this.position.y;
				dx = e4 - e6;
				dy = e7 - e5;
				c4 = Math.sqrt(dx * dx + dy * dy);
				dy *= 8.0 / c4;
				dx *= 8.0 / c4;
				this.position = {
					'x' : e4 - dx,
					'y' : e7 - dy
				};
				dx = this.position.x - e6;
				dy = this.position.y - e5;
				dx = dx > 5 ? 5 : (dx < -5 ? -5 : dx);
				dy = dy > 10 ?10 :(dy < -10 ? -10 : dy) - 3;
				this.velocity={
					x : dx,
					y : dy
				};
				
				for(n = 0; n < this.numpoints; n++){
					this.points[n].x *= 0.95;
					this.points[n].y *= 0.95;
				}
			}
			for(n = 0; n < this.numpoints; n++){
				var newx = this.cosine * this.points[n].x - this.sine * this.points[n].y;
				this.points[n].y = this.sine * this.points[n].x + this.cosine * this.points[n].y;
				this.points[n].x = newx;
			}
		};

		shapeClass.prototype.buildShape = function(x, y, radius, numpoints, colour){
			var n, ang, angi = Math.PI * 2 / numpoints, otherRadius;
			this.position={'x' : x, 'y' : y};
			this.numpoints = numpoints;
			this.radius = radius;
			this.ang = Math.random() * Math.PI * 2;
			this.angi = Math.random() * 0.2 + .01;
			this.points = [];
			this.colour = colour;
			otherRadius = radius * (1 + (!(this.numpoints % 2) && (this.numpoints > 8 || Math.random() < 0.5) ? 0.5 : 0));
			ang = this.ang;
			for(n = 0; n < this.numpoints; n++){
				if(n % 2){
					this.points[n] = {
						'x' : this.radius * Math.sin(ang),
						'y' : this.radius * Math.cos(ang)
					};
				}else{
					this.points[n] = {
						'x' : otherRadius * Math.sin(ang),
						'y' : otherRadius * Math.cos(ang)
					};
				}
				ang += angi;
			}
		};


		shapeClass.prototype.draw = function(){
			var n;

			context.save();
				context.beginPath();
				context.strokeStyle = 'rgba(' + (this.colour.R >> 1) + ', ' + (this.colour.G >> 1) + ', ' + (this.colour.B >> 1) + ', 1)';
				context.fillStyle = 'rgba(' + this.colour.R + ', ' + this.colour.G + ', ' + this.colour.B + ', ' + this.opacity + ')';
				context.lineWidth = 1;
				context.translate(this.position.x, this.position.y);
				context.moveTo(this.points[0].x, this.points[0].y);

				for(n = 1; n < this.numpoints; n++){
					context.lineTo(
						this.points[n].x, 
						this.points[n].y
					);
				}
				context.closePath();
				context.stroke();
				context.fill();
			context.restore();
		};

		shapeClass.prototype.scale = function(ratio){
			var n;
			for(n = 0; n < this.numpoints; n++){
				this.points[n].x *= ratio;
				this.points[n].y *= ratio;
			}
		};

		shapeClass.prototype.age = function(chainPos){
			chainPos = chainPos == undefined ? 0 : chainPos + 1;
			if(chainPos > 30){
				this.parentShape.childShape = null;
				this.parentShape = null;
				if(this.childShape != null){
					this.childShape.age(chainPos);
				}
			}else{
				if(this.childShape == null){
					if(this == leadShape){
						leadShape = null;
					}else{
						this.parentShape.childShape = null;
						this.parentShape = null;
					}
				}else{
					this.childShape.age(chainPos);
				}
			}
		};

		function buildCanvas(){
			var canvas = document.createElement("canvas");
			canvasWidth = canvas.width = document.body.clientWidth;
			canvasHeight = canvas.height = document.body.clientHeight;
			canvas.id = 'gameCanvas';
			document.body.appendChild(canvas);
			return canvas;
		}

		window.onload = function(){
			var canvas = buildCanvas();
			context = canvas.getContext('2d');
			canvas.onmousemove = function(evt){
				var x, y, colour;
				x = evt.clientX;
				y = evt.clientY;
				var dx = x - mouseX, dy = y - mouseY;
				colour ={
					'R' : Math.floor(128 + 100 * Math.sin(colourAngle)),
					'G' : Math.floor(128 + 100 * Math.cos(colourAngle)),
					'B' : Math.floor(128 - 100 * Math.sin(colourAngle))
				};
				if(dx * dx + dy * dy > 256){
					shape[numShapes] = new shapeClass();
					shape[numShapes].buildShape(x, y, 40, Math.floor(Math.random() * 10) + 3, colour);
					dx = dx > 5 ? 5 : (dx < -5 ? -5 : dx);
					dy = dy > 10 ? 10 : (dy < -10 ? -10 : dy) - 3;
					shape[numShapes].getTrigVals(dx / 30.0);
					mouseX = x;
					mouseY = y;
					shape[numShapes].velocity = {x : dx, y : dy};
					if(!mouseDown){
						if(leadShape != null){
							leadShape.parentShape = shape[numShapes];
						}
						shape[numShapes].childShape = leadShape;
						leadShape = shape[numShapes];
					}
					numShapes++;
					colourAngle += 0.05;
					if(colourAngle > 2 * Math.PI) colourAngle -= 2 * Math.PI;
				}
			};

			document.onmouseup = function(){
				mouseDown = false;
				if(leadShape != null){
					leadShape.age(10);
				}
			};

			document.onmousedown = function(){
				mouseDown = true;
			};

			setInterval(animate, 40);
		};

		function animate(){
			var n;
			context.clearRect(0, 0, canvasWidth, canvasHeight);
			for(n = 0; n < numShapes; n++){
				if(mouseDown){
					shape[n].scale(1.03);
				}
				shape[n].move();
				if(shape[n].position.y > canvasHeight + shape[n].radius){
					shape.splice(n, 1);
					n--;
					numShapes--;
				}else{
					shape[n].opacity *= 0.95;
					shape[n].draw();
				}
			}
			if(leadShape != null){
				leadShape.age();
			}
		}
	</script>
</head>
<body>
</body>
</html>
